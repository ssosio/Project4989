<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="boot.sagu.mapper.ChatMapper">
	
	<resultMap id="ChatResultMap" type="chat">
		<id column="chat_room_id" property="chat_room_id"/>
		<result column="product_id" property="product_id"/>
		<result column="seller_id" property="seller_id"/>
		<result column="buyer_id" property="buyer_id"/>
		<result column="created_at" property="created_at"/>
		<result column="last_message_at" property="last_message_at"/>
		<result column="opponent_nickname" property="opponent_nickname"/>
	</resultMap>
	
	<select id="getAllChat" resultMap="ChatResultMap">
		SELECT 
			c.chat_room_id,
			c.product_id,
			c.seller_id,
			c.buyer_id,
			c.created_at,
			c.last_message_at,
			CASE 
				WHEN c.seller_id = #{login_id} THEN m2.nickname
				WHEN c.buyer_id = #{login_id} THEN m1.nickname
			END as opponent_nickname
		FROM chatroom c
		LEFT JOIN members m1 ON c.seller_id = m1.member_id
		LEFT JOIN members m2 ON c.buyer_id = m2.member_id
		WHERE c.buyer_id = #{login_id} OR c.seller_id = #{login_id}
		ORDER BY c.last_message_at DESC
	</select>
</mapper>
